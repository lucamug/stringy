#!/bin/bash
set -eu

# This is a configuration file read by bash commands

ROOT_FOLDER=./
FOLDER_BUILD="docs"
FOLDER_TEMP="${FOLDER_BUILD}/TEMP"

NODE_MODULES_FOLDER=$ROOT_FOLDER/node_modules
PWD=`pwd`
SERVICE_NAME=$(basename $PWD)
TENANT_NAME=$(basename $(dirname $PWD))
BRANCH_NAME=$(git branch | sed -n -e 's/^\* \(.*\)/\1/p') || true
COMMIT_HASH=$(git rev-parse --short HEAD) || true
NX_PUBLIC_URL=$(printenv NX_PUBLIC_URL) || true

ELM=$NODE_MODULES_FOLDER/elm/bin/elm
ELM_GO=$NODE_MODULES_FOLDER/elm-go/bin/elm-go.js
ELM_JSON=$NODE_MODULES_FOLDER/elm-json/bin/elm-json
ELM_DOC_PREVIEW=$NODE_MODULES_FOLDER/elm-doc-preview/cli.js
ELM_REVIEW=$NODE_MODULES_FOLDER/elm-review/bin/elm-review
ELM_FORMAT=$NODE_MODULES_FOLDER/elm-format/bin/elm-format
ELM_TEST=$NODE_MODULES_FOLDER/elm-test/bin/elm-test

NODEAPP_TERSER=$NODE_MODULES_FOLDER/terser/bin/terser
NODEAPP_ESBUILD=$NODE_MODULES_FOLDER/esbuild/bin/esbuild
NODEAPP_REPLACE=$NODE_MODULES_FOLDER/replace/bin/replace.js
NODEAPP_HTML_MINIFIER=$NODE_MODULES_FOLDER/html-minifier/cli.js
NODEAPP_NPM_CHECK_UPDATES=$NODE_MODULES_FOLDER/npm-check-updates/build/src/bin/cli.js

# https://dev.to/ifenna__/adding-colors-to-bash-scripts-48g4

RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
MAGENTA="\e[35m"
CYAN="\e[36m"
GRAY="\e[90m"
BLACK="\e[30m"

LIGHT_RED="\e[91m"
LIGHT_GREEN="\e[92m"
LIGHT_YELLOW="\e[93m"
LIGHT_BLUE="\e[94m"
LIGHT_MAGENTA="\e[95m"
LIGHT_CYAN="\e[96m"
LIGHT_GRAY="\e[37m"

POINT="✨ "
STOP="\e[0m"
PRIMARY=$YELLOW
SECONDARY=$BLUE
DONE=" ${SECONDARY}done${STOP}\n"

function resetElmCache {
    if [ -d "elm-stuff" ]; then
        rm -rf elm-stuff
    fi

    if [ -d "~/.elm/0.19.0/package/*/*/*/*.dat" ]; then
        rm ~/.elm/0.19.0/package/*/*/*/*.dat
    fi
}

function removeAtomGarbage {
    find "./src" -name "Elmjutsu*" -type f -delete
}    

function echoCommand {
    printf "${BLUE}${POINT}Executing ${YELLOW}${0} ${BLUE}[${1}]${STOP}\n"
}

function singleCommand {
    echoCommand "${1}"
    printf "${YELLOW}${POINT}${2}${STOP}\n"
    printf "\n"
    eval "${1}"
}

function createIndexHtml {
    printf "${PRIMARY}${POINT}Creating index.html......."
    START_TIME=$SECONDS 
    SOURCE=static/index.template.html
    TARGET=static/index.html
    cp $SOURCE $TARGET
    COMMAND="$NODEAPP_REPLACE '\[=SERVICE_NAME\]'  '${SERVICE_NAME}'  ${TARGET} -m -i --silent"
    eval "${COMMAND}"
    COMMAND="$NODEAPP_REPLACE '\[=TENANT_NAME\]'   '${TENANT_NAME}'   ${TARGET} -m -i --silent"
    eval "${COMMAND}"
    COMMAND="$NODEAPP_REPLACE '\[=BRANCH_NAME\]'   '${BRANCH_NAME}'   ${TARGET} -m -i --silent"
    eval "${COMMAND}"
    COMMAND="$NODEAPP_REPLACE '\[=COMMIT_HASH\]'   '${COMMIT_HASH}'   ${TARGET} -m -i --silent"
    eval "${COMMAND}"
    COMMAND="$NODEAPP_REPLACE '\[=NX_PUBLIC_URL\]' '${NX_PUBLIC_URL}' ${TARGET} -m -i --silent"
    eval "${COMMAND}"
    COMMAND="$NODEAPP_REPLACE '<!DOCTYPE html>' '<!DOCTYPE html><!-- DO NOT EDIT - THIS FILE IS AUTOGENERATED FROM ${SOURCE} -->' ${TARGET} -m -i --silent"
    eval "${COMMAND}"
    ELAPSED_TIME=$(($SECONDS - $START_TIME))
    printf "$BLUE done in $ELAPSED_TIME secs$STOP\n"
}

printf "${BLUE}┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓${STOP}\n"
printf "${BLUE}┃               ┏━━┓┏┓                      ┃${STOP}\n"
printf "${BLUE}┃               ┃┏━┛┃┃                      ┃${STOP}\n"
printf "${BLUE}┃               ┃┗┓ ┃┃ ┏━━━━┓               ┃${STOP}\n"
printf "${BLUE}┃               ┃┏┛ ┃┃ ┃┏┓┏┓┃               ┃${STOP}\n"
printf "${BLUE}┃               ┃┗━┓┃┗┓┃┃┃┃┃┃               ┃${STOP}\n"
printf "${BLUE}┃               ┗━━┛┗━┛┗┛┗┛┗┛               ┃${STOP}\n"
printf "${BLUE}┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛${STOP}\n"
printf "${BLUE} Commit: $COMMIT_HASH  Branch: $BRANCH_NAME${STOP}\n"
printf "\n"
